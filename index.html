<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bondon Internet Service</title>
<!-- FontAwesome for Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; margin:0; padding:0; }
    .container { max-width: 1200px; margin: 30px auto; padding: 25px; background: #fff; border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.05); }
    
    /* Header Style */
    h1 { 
        text-align:center; 
        color: #fff; 
        background: linear-gradient(to right, #4facfe 0%, #00f2fe 100%);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    h3 { color: #2c3e50; border-left: 5px solid #3498db; padding-left: 10px; margin-top: 30px;}

    /* COLORFUL DASHBOARD */
    .dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
    
    .card { 
        padding: 20px; 
        border-radius: 12px; 
        text-align: center; 
        color: white; 
        position: relative; 
        overflow: hidden;
        transition: transform 0.3s, box-shadow 0.3s;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    
    .card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
    
    .card h4 { margin: 0; font-size: 14px; text-transform: uppercase; opacity: 0.9; letter-spacing: 1px; }
    .card .val { font-size: 28px; font-weight: bold; margin-top: 10px; }
    .card i { font-size: 40px; position: absolute; right: 10px; bottom: 10px; opacity: 0.2; }

    /* Card Colors (Gradients) */
    .c-blue { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .c-orange { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .c-green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .c-red { background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); }

    /* Input Form */
    .input-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    input, select { padding: 12px; width: 100%; box-sizing: border-box; border: 1px solid #ddd; border-radius: 6px; background: #f9f9f9; transition: 0.3s; }
    input:focus, select:focus { border-color: #3498db; outline: none; background: #fff; }
    
    /* Buttons */
    button { padding: 12px; cursor:pointer; background:#34495e; color:#fff; border:none; border-radius:6px; font-size: 14px; transition: 0.3s; width: 100%; font-weight: 600; }
    button:hover { opacity: 0.9; transform: scale(1.02); }
    button.add-btn { background: linear-gradient(to right, #11998e, #38ef7d); grid-column: span 3; font-size: 16px; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3); } 
    
    /* Header Buttons */
    .header-btns { float: right; display: flex; gap: 10px; }
    button.excel { background: #f39c12; width: auto; padding: 8px 20px; }
    button.import { background: #8e44ad; width: auto; padding: 8px 20px; }
    
    /* Table */
    table { width:100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; border-radius: 8px; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
    table, th, td { border: none; }
    th { background: #34495e; color: #fff; padding: 15px; text-align: center; text-transform: uppercase; font-size: 12px; letter-spacing: 1px; }
    td { padding: 12px; text-align:center; vertical-align: middle; border-bottom: 1px solid #eee; }
    tr:nth-child(even) { background-color: #f8f9fa; }
    tr:hover { background-color: #e8f4f8; }
    
    .total-row { background-color: #ecf0f1; font-weight: bold; font-size: 16px; color: #2c3e50; }

    /* Actions */
    .action-cell { white-space: nowrap; }
    .btn-sm { width: auto; display: inline-block; padding: 6px 10px; margin: 0 2px; font-size: 11px; border-radius: 20px; text-transform: uppercase; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .btn-collect { background: #2ecc71; }
    .btn-pdf { background: #3498db; }
    .btn-edit { background: #e67e22; }
    .btn-del { background: #e74c3c; }

    /* Controls */
    .controls { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; background: #f1f2f6; padding: 15px; border-radius: 8px; }
    .search-bar { flex: 2; min-width: 200px; border: 1px solid #ccc; }
    .filter-select { flex: 1; min-width: 120px; }
    .btn-show-all { background: #2c3e50; color: white; flex: 0.5; min-width: 100px; }

    /* Pagination */
    .pagination { margin-top: 25px; text-align:center; }
    .pagination button { width: 35px; height: 35px; margin: 0 5px; padding: 0; border-radius: 50%; background: #fff; color: #333; border: 1px solid #ddd; display: inline-flex; align-items: center; justify-content: center; }
    .pagination button.active { background: #3498db; color: #fff; border-color: #3498db; }
</style>
</head>
<body>

<div class="container">
    <h1><i class="fas fa-wifi"></i> Bondon Internet Service</h1>

    <!-- COLORFUL DASHBOARD -->
    <div class="dashboard">
        <div class="card c-blue">
            <h4>Total Customers</h4>
            <div class="val" id="totalCust">0</div>
            <i class="fas fa-users"></i>
        </div>
        <div class="card c-orange">
            <h4>Total Bill Amount</h4>
            <div class="val" id="totalBill">0</div>
            <i class="fas fa-file-invoice-dollar"></i>
        </div>
        <div class="card c-green">
            <h4>Total Collected</h4>
            <div class="val" id="totalPaid">0</div>
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="card c-red">
            <h4>Total Due</h4>
            <div class="val" id="totalDue">0</div>
            <i class="fas fa-exclamation-triangle"></i>
        </div>
    </div>

    <h3><i class="fas fa-user-plus"></i> Add / Edit Customer</h3>
    <div class="input-group">
        <input type="text" id="name" placeholder="Customer Name">
        <input type="text" id="mobile" placeholder="Mobile Number">
        <input type="text" id="userId" placeholder="User ID (PPPoE)">
        <input type="number" id="plan" placeholder="Monthly Bill Amount">
        <input type="date" id="connDate" placeholder="Connection Date">
    </div>
    <button class="add-btn" id="mainBtn" onclick="handleCustomerSubmit()">+ Add Customer</button>

    <div style="margin-top: 40px; display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin:0; border:none;"><i class="fas fa-list"></i> Customer List</h3>
        <div class="header-btns">
            <input type="file" id="importFile" style="display:none" accept=".xlsx, .xls" onchange="handleFileImport(event)">
            <button class="import" onclick="document.getElementById('importFile').click()"><i class="fas fa-file-import"></i> Import</button>
            <button class="excel" onclick="exportExcel()"><i class="fas fa-file-excel"></i> Export</button>
        </div>
    </div>
    
    <!-- Controls -->
    <div class="controls" style="margin-top: 15px;">
        <input class="search-bar" type="text" id="search" placeholder="Search by Name, Mobile..." oninput="renderTable()">
        
        <select class="filter-select" id="yearFilter" onchange="renderTable()"><option value="">All Years</option></select>
        
        <select class="filter-select" id="monthFilter" onchange="renderTable()">
            <option value="">All Months</option>
            <option value="01">January</option><option value="02">February</option><option value="03">March</option>
            <option value="04">April</option><option value="05">May</option><option value="06">June</option>
            <option value="07">July</option><option value="08">August</option><option value="09">September</option>
            <option value="10">October</option><option value="11">November</option><option value="12">December</option>
        </select>
        
        <select class="filter-select" id="statusFilter" onchange="renderTable()">
            <option value="all">Status: All</option><option value="paid">Paid</option><option value="due">Due</option>
        </select>

        <button class="btn-show-all" id="showAllBtn" onclick="toggleShowAll()">Show All</button>
    </div>

    <table id="customerTable"></table>
    <div class="pagination" id="pagination"></div>
</div>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<script>
    let customers = JSON.parse(localStorage.getItem('customers') || '[]');
    let currentPage = 1;
    const rowsPerPage = 15;
    let editIndex = -1;
    let isShowAll = false;

    // Populate Year
    const yearSelect = document.getElementById('yearFilter');
    const currentYear = new Date().getFullYear();
    for (let i = currentYear + 1; i >= currentYear - 5; i--) {
        let option = document.createElement('option');
        option.value = i; option.text = i; yearSelect.appendChild(option);
    }

    const formatMoney = (amount) => Number(amount).toLocaleString('en-US');

    function toggleShowAll() {
        isShowAll = !isShowAll;
        const btn = document.getElementById('showAllBtn');
        if(isShowAll) {
            btn.innerText = "Show Pages";
            btn.style.background = "#7f8c8d";
        } else {
            btn.innerText = "Show All";
            btn.style.background = "#2c3e50";
        }
        renderTable();
    }

    function renderTable() {
        const table = document.getElementById('customerTable');
        const searchValue = document.getElementById('search').value.toLowerCase();
        const statusValue = document.getElementById('statusFilter').value;
        const yearValue = document.getElementById('yearFilter').value;
        const monthValue = document.getElementById('monthFilter').value;

        const filtered = customers.filter(c => {
            const matchesSearch = (c.name || '').toLowerCase().includes(searchValue) || 
                                  (c.mobile || '').includes(searchValue) ||
                                  (c.userId || '').toLowerCase().includes(searchValue);
            const matchesStatus = statusValue === 'all' || (statusValue === 'paid' && c.paid) || (statusValue === 'due' && !c.paid);
            
            let matchesDate = true;
            if (c.connDate) {
                const dateObj = new Date(c.connDate);
                if(!isNaN(dateObj)) {
                    const cYear = dateObj.getFullYear().toString();
                    const cMonth = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                    if (yearValue && cYear !== yearValue) matchesDate = false;
                    if (monthValue && cMonth !== monthValue) matchesDate = false;
                }
            } else if (yearValue || monthValue) matchesDate = false;

            return matchesSearch && matchesStatus && matchesDate;
        });

        // Dashboard
        const totalAmount = filtered.reduce((sum, c) => sum + Number(c.plan || 0), 0);
        const totalPaid = filtered.filter(c => c.paid).reduce((sum, c) => sum + Number(c.plan || 0), 0);
        
        document.getElementById('totalCust').innerText = filtered.length;
        document.getElementById('totalBill').innerText = formatMoney(totalAmount);
        document.getElementById('totalPaid').innerText = formatMoney(totalPaid);
        document.getElementById('totalDue').innerText = formatMoney(totalAmount - totalPaid);

        // Pagination
        let paginated;
        let totalPages = 1;

        if (isShowAll) {
            paginated = filtered;
            document.getElementById('pagination').style.display = 'none';
        } else {
            totalPages = Math.ceil(filtered.length / rowsPerPage);
            if (currentPage > totalPages) currentPage = totalPages || 1;
            const start = (currentPage - 1) * rowsPerPage;
            paginated = filtered.slice(start, start + rowsPerPage);
            document.getElementById('pagination').style.display = 'block';
        }

        let html = `<thead><tr><th>Name</th><th>User ID</th><th>Mobile</th><th>Conn. Date</th><th>Bill Amount</th><th>Status</th><th style="width: 220px;">Actions</th></tr></thead><tbody>`;

        if(paginated.length === 0) html += `<tr><td colspan="7" style="padding:20px; color:#777;">No customers found</td></tr>`;
        else {
            paginated.forEach((c) => {
                const index = customers.indexOf(c);
                html += `<tr>
                    <td style="text-align:left; font-weight:bold; color:#2c3e50;">${c.name}</td>
                    <td>${c.userId || '-'}</td>
                    <td>${c.mobile || '-'}</td>
                    <td>${c.connDate || '-'}</td>
                    <td>${c.plan}</td>
                    <td><span style="padding: 4px 8px; border-radius: 4px; background:${c.paid ? '#d4edda':'#f8d7da'}; color:${c.paid ? '#155724':'#721c24'}; font-weight:bold;">${c.paid ? 'Paid':'Due'}</span></td>
                    <td class="action-cell">
                        <button class="btn-sm btn-collect" onclick="toggleStatus(${index})"><i class="fas fa-hand-holding-usd"></i> ${c.paid ? 'Unpaid' : 'Pay'}</button>
                        <button class="btn-sm btn-edit" onclick="editCustomer(${index})"><i class="fas fa-edit"></i></button>
                        <button class="btn-sm btn-pdf" onclick="generatePDF(${index})"><i class="fas fa-file-pdf"></i></button>
                        <button class="btn-sm btn-del" onclick="deleteCustomer(${index})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
        }
        html += `<tr class="total-row"><td colspan="4" style="text-align:right;">Total Bill:</td><td>${formatMoney(totalAmount)}</td><td colspan="2"></td></tr></tbody>`;
        table.innerHTML = html;

        if (!isShowAll) {
            const pagDiv = document.getElementById('pagination');
            pagDiv.innerHTML = '';
            for(let i=1; i<=totalPages; i++){
                const btn = document.createElement('button');
                btn.innerText = i;
                if(i === currentPage) btn.classList.add('active');
                btn.onclick = () => { currentPage = i; renderTable(); };
                pagDiv.appendChild(btn);
            }
        }
    }

    function handleCustomerSubmit() {
        const name = document.getElementById('name').value;
        const mobile = document.getElementById('mobile').value;
        const userId = document.getElementById('userId').value;
        const plan = document.getElementById('plan').value;
        const connDate = document.getElementById('connDate').value;

        if (!name || !plan) { alert('Name and Bill Amount are required!'); return; }

        if (editIndex === -1) customers.push({ name, mobile, userId, plan, connDate, paid: false });
        else {
            customers[editIndex] = { ...customers[editIndex], name, mobile, userId, plan, connDate };
            editIndex = -1;
            const btn = document.getElementById('mainBtn');
            btn.innerHTML = "+ Add Customer"; btn.style.background = "linear-gradient(to right, #11998e, #38ef7d)";
        }
        saveAndRender();
        document.querySelectorAll('input').forEach(i => i.value = '');
    }

    function editCustomer(i) {
        const c = customers[i];
        document.getElementById('name').value = c.name;
        document.getElementById('mobile').value = c.mobile;
        document.getElementById('userId').value = c.userId;
        document.getElementById('plan').value = c.plan;
        document.getElementById('connDate').value = c.connDate;
        editIndex = i;
        const btn = document.getElementById('mainBtn');
        btn.innerText = "Update Customer"; btn.style.background = "#e67e22";
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function handleFileImport(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            let count = 0;
            jsonData.forEach(row => {
                let nameVal = '', mobileVal = '', userVal = '', planVal = '', dateVal = '';
                Object.keys(row).forEach(key => {
                    const k = key.toLowerCase().trim();
                    const val = row[key];
                    if(k.includes('name') && !k.includes('user')) nameVal = val;
                    else if(k.includes('mobile') || k.includes('phone')) mobileVal = val;
                    else if(k.includes('user') || k.includes('id')) userVal = val;
                    else if(k.includes('bill') || k.includes('amount') || k.includes('plan')) planVal = val;
                    else if(k.includes('date') || k.includes('conn')) dateVal = val;
                });
                if (nameVal && planVal) {
                    let cDate = dateVal;
                    if (typeof cDate === 'number') {
                        const dateObj = new Date(Math.round((cDate - 25569)*86400*1000));
                        cDate = dateObj.toISOString().split('T')[0];
                    }
                    customers.push({ name: nameVal, mobile: mobileVal, userId: userVal, plan: planVal, connDate: cDate, paid: false });
                    count++;
                }
            });
            if(count > 0) { alert(`Successfully imported ${count} customers!`); saveAndRender(); } 
            else { alert('No valid data found.'); }
            event.target.value = '';
        };
        reader.readAsArrayBuffer(file);
    }

    function toggleStatus(i) { customers[i].paid = !customers[i].paid; saveAndRender(); }
    function deleteCustomer(i) { if (confirm('Delete customer?')) { customers.splice(i, 1); saveAndRender(); } }
    function saveAndRender() { localStorage.setItem('customers', JSON.stringify(customers)); renderTable(); }

    function exportExcel() {
        const ws_data = [['Name', 'User ID', 'Mobile', 'Connection Date', 'Bill Amount', 'Status']];
        let total = 0;
        customers.forEach(c => {
            ws_data.push([c.name, c.userId, c.mobile, c.connDate, c.plan, c.paid ? 'Paid' : 'Due']);
            total += Number(c.plan || 0);
        });
        ws_data.push(['', '', '', 'TOTAL BILL:', total, '']);
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        ws['!cols'] = [{wch:20}, {wch:15}, {wch:15}, {wch:15}, {wch:10}, {wch:10}];
        XLSX.utils.book_append_sheet(wb, ws, 'Customers');
        XLSX.writeFile(wb, 'Bondon_Report.xlsx');
    }

    function generatePDF(i) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const c = customers[i];
        doc.setFillColor(52, 152, 219); doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255, 255, 255); doc.setFontSize(22); doc.text("Bondon Internet Service", 105, 25, null, null, "center");
        doc.setTextColor(0, 0, 0); doc.setFontSize(16); doc.text("INVOICE", 105, 55, null, null, "center");
        doc.setFontSize(12); let y = 70;
        doc.text(`Customer Name: ${c.name}`, 20, y); y+=10;
        doc.text(`User ID: ${c.userId || 'N/A'}`, 20, y); y+=10;
        doc.text(`Mobile: ${c.mobile || 'N/A'}`, 20, y); y+=10;
        doc.text(`Connection Date: ${c.connDate || 'N/A'}`, 20, y); y+=20;
        doc.rect(20, y-10, 170, 30);
        doc.setFontSize(14); doc.text(`Monthly Bill Amount:`, 30, y+10); doc.setFont("helvetica", "bold"); doc.text(`${c.plan} Tk`, 150, y+10);
        y += 35; doc.setFont("helvetica", "normal"); doc.setFontSize(12); doc.text(`Status: ${c.paid ? 'PAID' : 'DUE'}`, 20, y);
        doc.setFontSize(10); doc.setTextColor(150); doc.text("Thank you for using Bondon Internet Service", 105, 280, null, null, "center");
        doc.save(`${c.name}_Invoice.pdf`);
    }

    renderTable();
</script>
</body>
</html>